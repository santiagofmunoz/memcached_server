# Memcached Server

## Introduction

This is an implentation of a memcached server based on the coding challenge by Moove-It. The application is written in Ruby and it doesn't use anyother external gem apart from the ones included in the standard installation of Ruby.

## Implemented Methods

### Storage Commands

- Set
- Add
- Replace
- Append
- Prepend
- Cas

### Retrieval Commands

- Get
- Gets

### Issues solved

- Purge expired keys.
- Management of multiple clients.
- Desing load tests and include the test plan (for example, JMeter files) as part of the codebase

## Installation

Clone or download this repository to any directory you want in your computer. After that, you have to open a Terminal/Cmd (depending on your OS) where you cloned the repository and run ```ruby start_server.rb```

The software was created and tested in this environment and due to this, it's the recommended environment to run it:

- OS: Ubuntu 20.04 LTS (Focal Fossa) 64-bit.
- Ruby 2.7.0 (obtained via [RVM](https://rvm.io/))

Nonetheless, it should work in other OSes and higher versions of Ruby. Feel free to let me know if it doesn't.

## How to use it

This is an implementation of a TCP Server, so, in order to use it, you'll need a TCP Client.

Any TCP Client can be used, but if you don't want to search or implement a TCP Client you can use it by writing ```telnet [IP_Address] [Port]``` in any Terminal/Cmd (or the equivalent command depending on your OS). By the default, the software uses localhost (```127.0.0.1```) as IP Address and ```11211``` as Port (This specific port is the same used by Memcached).

After that, you can issue any command you want. As requested by the challenge, I've followed [Memcached's protocol](https://github.com/memcached/memcached/blob/master/doc/protocol.txt) to write the commands for this software.

Here's a quick view on how to write the commands.

### Commands Usage

#### Storage Commands

```<command name> <key> <flags> <exptime> <bytes> [noreply]```

- ```<command name>```: The command that you want to execute (i.e ```set```, ```add```, ```replace```, etc)
- ```<key>``` : Identification of the value that you want to save (It can be a number, a word, but it can't have whitespaces).
- ```<flags>```: "Is an arbitrary 16-bit unsigned integer (written out in decimal) that the server stores along with the data and sends back when the item is retrieved. Clients may use this as a bit field to store data-specific information" [Citation from Memcached's protocol](https://github.com/memcached/memcached/blob/82029ecc9b3dd0f57b3f9ab9761f44714cceed6f/doc/protocol.txt#L225)
- ```<exptime>```: Expiration time of the stored entry. It can be written in seconds or in UNIX Time.
- ```<bytes>```: Size in bytes (Number) of the value that will be stored. If the value is bigger than the size specified, the object won't be saved.
- ```[noreply]```: (Optional) Instructs the server to not send the reply

The command cas has a slightly change on its structure.

```cas <key> <flags> <exptime> <bytes> <cas unique>```

- ```<cas unique>```: Is a unique value generated by the server for a specific entry

After writing the desired command, the data block should be written.

##### Sample commands

```
set a1 1 10000 8
datatest
```

```
add a2 1 1640995199 9 noreply
datatest1
```

```
replace a1 1 20000 9
datatest2
```

```
append a1 1 20000 17 noreply
datatest3
```

```
prepend a1 1 20000 17
datatest4
```

```
cas a1 1 20000 9 1
datatest5
```

#### Retrieval Commands

```get <key>```

```gets <key>```

- ```<key>```: Identification of the saved object, it can be one or more strings, separated by whitespace.

##### Sample commands

```get a1```

```gets a1 a2```

## Running the tests

### Unit tests

First of all, you'll have to start the server using ```ruby start_server.rb``` in the root folder of the software. This is required because the software has connection tests and they'll fail if they don't have a server to connect to. After this, go to ```tests``` folder in the repository and run ```ruby run_tests.rb```. This will execute all the unit tests created for the software.

### JMeter test

To run the JMeter tests, you'll have to open the file ```jmeter_test.jmx``` with Apache JMeter. There, you'll find this structure.

- Test Plan
  - Thread Group
    - [...] Command
      - View Results Tree
    - [...] Command
      - View Results Tree
    - TCP Sampler Config

In "Thread Group" you can configure the number of users that are going to execute the commands, which by default are configured at 100 users. Also you can configure the ramp-up period, loop count, etc.

Inside "Thread Group" you'll find each command in a different sampler and inside every sampler, a table to see the results of the execution.

In order to execute the samplers, you have to enable each one of them separately (also disabling the previous enabled one) and run the test. After all the users have connected to the socket, you'll have to stop the test manually in order to see the results of the test (Sorry about this, it's my first time using this program and I don't fully know how to use it). The results will be displayed in red and with a cross, indicating that they've failed. Fear not, this doesn't mean that the test has failed, the real result is displayed in the tab "Response data", inside the results tree. If the result in "Response data" is the one expected, the test is successful, otherwise, it has failed.

> **IMPORTANT NOTE**
> 
> In order to execute the command cas and execute it successfully, you must follow these steps.
>
> 1. Start the server.
> 2. Run set/add command in only one thread group.
> 3. (Optional) Run gets command to check that the cas number is the same number as the key, if it isn't, the command won't work.
> 4. Run cas command.
>
> Why does this have to be this way? Well, the cas command, as you might have seen with the other commands, base their key and flag on a counter, this counter restarts every time we execute a different test, but the cas_value always increases and changes, since it's automatically generated by the server. In a normal situation, you'd check first with gets the cas value to execute cas later, but as this a structured test, it's the way I found it works.

In "TCP Sampler Config" you can find the configuration set to all the samplers, there you can change the IP of the Memcached server if you have the server in another IP apart from "127.0.0.1", the port number (11211 is the default port number, also the one used by Memcached) and other configurations. Remember that changes in this element will have repercussion on all the samplers.

## References

- [Moove-It's code challenge](https://github.com/moove-it/coding-challenges/blob/master/ruby.md)
- [Memcached](https://github.com/memcached/memcached)
- [Memcached protocol](https://github.com/memcached/memcached/blob/master/doc/protocol.txt)
